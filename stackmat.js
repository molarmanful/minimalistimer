(function(){var t,n=function(t,n){return function(){return t.apply(n,arguments)}};t={},t.State=function(){function t(){this.running=!1,this.digits=[0,0,0,0,0],this.leftHandPressed=!1,this.rightHandPressed=!1,this.reset=!0}return t.prototype.update=function(t){var n;switch(this.leftHandPressed=this.rightHandPressed=!1,n=t.getStatus()){case" ":this.running=!0,this.reset=!1;break;case"S":this.running=!1,this.reset=!1;break;case"I":this.running=!1,this.reset=!0;break;case"L":this.leftHandPressed=!0;break;case"R":this.rightHandPressed=!0;break;case"C":this.running=!1,this.leftHandPressed=!0,this.rightHandPressed=!0}return this.digits=t.getDigits()},t.prototype.isRunning=function(){return this.running},t.prototype.isReset=function(){return this.reset},t.prototype.isLeftHandPressed=function(){return this.leftHandPressed},t.prototype.isRightHandPressed=function(){return this.rightHandPressed},t.prototype.getTimeAsString=function(){return""+this.digits[0]+":"+this.digits[1]+this.digits[2]+"."+this.digits[3]+this.digits[4]},t.prototype.getTimeInMilliseconds=function(){var t,n;return n=60*this.digits[0]+10*this.digits[1]+this.digits[2],t=10*this.digits[3]+this.digits[4],1e3*n+10*t},t}(),t.Signal=function(){function t(t){var n;this.status=String.fromCharCode(t.status),this.digits=function(){var i,e,r,s;for(r=t.digits,s=[],i=0,e=r.length;e>i;i++)n=r[i],s.push(n-48);return s}()}return t.prototype.getStatus=function(){return this.status},t.prototype.getDigits=function(){return this.digits},t}(),t.SignalDecoder=function(){function i(){this.decode=n(this.decode,this)}var e,r,s;return e=function(t,n){return-1!==n.indexOf(t)},s=function(t){var n,i,e;return e=function(){var i,e,r;for(r=[],i=0,e=t.length;e>i;i++)n=t[i],r.push(n-48);return r}(),i=e.reduce(function(t,n){return t+n})},r=function(t){return e(String.fromCharCode(t[0]),"IA SLRC")&&e(String.fromCharCode(t[1]),"0123456789")&&e(String.fromCharCode(t[2]),"0123456789")&&e(String.fromCharCode(t[3]),"0123456789")&&e(String.fromCharCode(t[4]),"0123456789")&&e(String.fromCharCode(t[5]),"0123456789")&&s(t.slice(1,6))===t[6]-64&&10===t[7]&&13===t[8]},i.prototype.decode=function(n){return r(n)?new t.Signal({status:n[0],digits:n.slice(1,6)}):void 0},i}.call(this),t.AudioHardware=function(){function t(t,n){var i=this;this.source=t,this.node=t.context.createJavaScriptNode(8192,1,1),this.callback=n,this.node.onaudioprocess=function(t){return i.callback(t.inputBuffer.getChannelData(0))},t.connect(this.node),this.node.connect(t.context.destination)}return t}(),t.RS232Decoder=function(){function t(t){this.decode=n(this.decode,this),this.findBeginningOfSignal=n(this.findBeginningOfSignal,this),this.ticksPerBit=t}var i,e,r,s,o;return e=function(t){return 0>t?1:t>0?0:void 0},t.prototype.findBeginningOfSignal=function(t){var n,i,e,r;for(e=0,r=!1,i=0;i<t.length;){if(n=t[i],1===n&&(e+=1),e>9*this.ticksPerBit&&(r=!0),0===n&&(e=0,r))return i;i+=1}return void 0},o=function(t){var n,i,e;for(i=-1,e=[],n=0;n<t.length;)i!==t[n]?(e.push({bit:t[n],length:1}),i=t[n]):e[e.length-1].length+=1,n+=1;return e},r=function(t,n){var i,e,r,s,o;return s=function(){var s,o,u;for(u=[],s=0,o=t.length;o>s;s++)e=t[s],u.push((i=Math.round(e.length/n),function(){var t,n;for(n=[],r=t=1;i>=1?i>=t:t>=i;r=i>=1?++t:--t)n.push(e.bit);return n}()));return u}(),(o=[]).concat.apply(o,s)},i=function(t,n){var i,e;for(e=0,i=0;8>i;)e+=t[n+i]<<i,i+=1;return e},s=function(t){var n,e,r;for(r=[],n=e=0;8>=e;n=++e)r.push(i(t,10*n));return r},t.prototype.decode=function(t){var n,i,u,a;return n=function(){var n,r,s;for(s=[],n=0,r=t.length;r>n;n++)i=t[n],s.push(e(i));return s}(),a=this.findBeginningOfSignal(n),u=o(n.slice(a,+(n.length-1)+1||9e9)),n=r(u,this.ticksPerBit),s(n.slice(1,+(n.length-1)+1||9e9))},t}.call(this),t.Timer=function(){function i(i){this.stop=n(this.stop,this),this.start=n(this.start,this),this.signalFetched=n(this.signalFetched,this);var s=this;return r()?(this.onRunning=i.onRunning||function(){},this.onStopping=i.onStopping||function(){},this.onResetting=i.onResetting||function(){},this.signalReceived=i.signalReceived||function(){},this.capturing=!1,this.state=new t.State,this.rs232Decoder=new t.RS232Decoder(e().sampleRate/1200),this.stackmatSignalDecoder=new t.SignalDecoder,void navigator.webkitGetUserMedia({audio:!0},function(n){var i;return i=e().createMediaStreamSource(n),s.device=new t.AudioHardware(i,s.signalFetched)})):void alert("You need a recent browser in order to connect your Stackmat Timer.")}var e,r;return r=function(){return!!(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia)},e=function(){if("function"==typeof AudioContext)return new AudioContext;if("function"==typeof webkitAudioContext)return new webkitAudioContext;throw new Error("AudioContext not supported. :(")},i.prototype.signalFetched=function(t){var n;if(this.capturing){if(n=this.rs232Decoder.decode(t),null==n)return;if(t=this.stackmatSignalDecoder.decode(n),null==t)return;return this.state.update(t),this.signalReceived(this.state)}},i.prototype.start=function(){return this.capturing=!0},i.prototype.stop=function(){return this.capturing=!1},i}.call(this),("undefined"!=typeof exports&&null!==exports?exports:this).Stackmat=t}).call(this);
